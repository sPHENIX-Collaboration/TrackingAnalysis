# Data macro for Physics Validation TF
This support starting from any level of DSTs, and produce various QA outputs

- Obtain DST lists

If you want to start from Raw Hit DSTs, please use ``getFiles_rawhit.sh``.
Modify here according to what run species (``run2pp`` or ``run3auau`` or ``run3pp``), run type (always ``physics``), ana build (``anaXXX``), cdb tag (always ``nocdbtag`` for raw hit DSTs), and version number (``vXXX``)
```
runspecies='run2pp'
runtype='physics'
anabuild='ana479'
cdbtag='nocdbtag'
version='v001'
```
Then change here according to how many events per DST (``NumEvtPerDst``) and how many events you want to analysis per job (``NumEvtPerJob``)
```
NumEvtPerDst=10000
NumEvtPerJob=10000
```
For example, you want to obtain raw hit DST list of run 53877, execute
```
./getFiles_rawhit.sh 53877
```
The output file list will show up in a new directory ``fileLists``.
If you want to analyze higher level of DSTs, e.g. cluster DST, seed DST, track DST, please use ``getFiles.sh``, and change the following lines:
```
runSpecies=run2pp
buildTag=ana506_2024p023_v001
dstType=DST_TRKR_TRACKS
nTotal=10000 #10000 events per segment
nEvents=5000 # nEvents per job
```
Execute in a similar way:
```
./getFiles.sh 53877
```

- Macro set up

Macro and run script are stored in ``macro/`` directory
```
Fun4All_HF.C  HF_selections.C  runHFreco.sh
```
Currently, it supports KFParticle QA for reconstructing four resonances: $K_S^0,\ \Lambda,\ \phi,\ D^0$ as well as various Tracking QA modules which depends on which level of DST you input.
For KFParticle QA, if you want to enable or disable specific channel, please go to ``HF_selections.C`` and modify here:
```
  bool run_pipi_reco = true;
  bool run_ppi_reco = true;
  bool run_KK_reco = true;
  bool run_Kpi_reco = true;
```
Currently, KFParticle nTuples will not be generated by default. Only QA histogram root files are generated. If you want to look into nTuples in detail, please enable this line:
```
  bool save_kfpntuple = true;
```
If you want get trigger info, detector info, dEdx info, calo info,n your output nTuples please enable these lines:
```
bool get_trigger_info = true;
bool get_detector_info = true;
bool get_dEdx_info = true;
bool get_calo_info = true;
```

**These flags automatically input cluster DSTs or calo DSTs in Fun4All_HF.C**

If your input is seed or track DST which do not contain cluster info, but you want to get detector info (cluster position etc.) and dEdx info, please enable 
```
bool get_detector_info = true;
bool get_dEdx_info = true;
```
Then go to ``Fun4All_HF.C`` and change cluster DST anabuild, cdbtag, version (``clus_anacdbver``) to match with your input
```c++
  if (get_dEdx_info || get_detector_info)
  {
    std::string clus_anacdbver = "ana505_2024p023_v001";
    std::string clus_file = "";
    if (runspecies=="run3pp" || runspecies=="run3auau")
    {
      clus_file = "/sphenix/lustre01/sphnxpro/production/" + runspecies + "/physics/" + clus_anacdbver + "/DST_TRKR_CLUSTER/run_"
	      + nice_rounded_down.str() + "_" + nice_rounded_up.str()
	      + "/DST_TRKR_CLUSTER_" + runspecies + "_" + clus_anacdbver + "-" + nice_runnumber.str() + "-" + nice_segment.str() + ".root";
    }
    if (runspecies=="run2pp")
    {
      clus_file = "/sphenix/lustre01/sphnxpro/production/" + runspecies + "/physics/" + clus_anacdbver + "/DST_TRKR_CLUSTER/run_"
	      + nice_rounded_down.str() + "_" + nice_rounded_up.str()
	      + "/dst/DST_TRKR_CLUSTER_" + runspecies + "_" + clus_anacdbver + "-" + nice_runnumber.str() + "-" + nice_segment.str() + ".root";
    }
    std::cout << "Input cluster DST: " << clus_file << std::endl;

    auto hitsinclus = new Fun4AllDstInputManager("ClusterInputManager");
    hitsinclus->fileopen(clus_file);
    se->registerInputManager(hitsinclus);
  }
```

If you want to do track-calo matching study, please enable 
```
bool get_calo_info = true;
```
Then go to ``Fun4All_HF.C`` and change calo DST anabuild, cdbtag, version (``calo_anacdbver``) and set the ratio between nEvents per calo DST segment and nEvents per tracking DST segment (``ratio_nCalo_over_nTrkr``, default is 10 = 100000 / 10000) to match with your input
```c++
  if (get_calo_info)
  {
    int ratio_nCalo_over_nTrkr = 10; // number of events per calo DST divided by number of events per tracking DST
    std::stringstream nice_segment_calo;
    nice_segment_calo << std::setw(5) << std::setfill('0') << to_string(segment / ratio_nCalo_over_nTrkr);

    std::string calo_anacdbver = "ana509_2024p022_v001";
    std::string calo_file = "";
    calo_file = "/sphenix/lustre01/sphnxpro/production2/" + runspecies + "/physics/calofitting/" + calo_anacdbver + "/run_"
	    + nice_rounded_down.str() + "_" + nice_rounded_up.str()
	    + "/DST_CALOFITTING_" + runspecies + "_" + calo_anacdbver + "-" + nice_runnumber.str() + "-" + nice_segment_calo.str() + ".root";
    std::cout << "Input calo DST: " << calo_file << std::endl;

    auto hitsincalo = new Fun4AllDstInputManager("CaloInputManager");
    hitsincalo->fileopen(calo_file);
    se->registerInputManager(hitsincalo);
  }
```

- Submit jobs

Modify ``myCondor.job``, basically only change this line to your absolute local path
```
Initialdir         = ./
```

**Remember to create a ``log`` directory for condor output files (log,out,err).**

Use ``submitCondorJobs.sh`` to submit jobs. Modify this line to whatever runs you want to analyze, and separate the different runs with spaces.
```
runs="53783 53756 53877 53876"
```
Then execute it
```
source submitCondorJobs.sh
```
QA outputs will show up in a new directory ``root/``

Have fun checking data! :)
